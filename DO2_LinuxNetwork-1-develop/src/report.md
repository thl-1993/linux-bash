## Сети в Linux

## Part 1. Инструмент ipcalc
#### 1.1. Сети и маски
- установка ipcalc
![Alt text](image-1.png)
##### Определить и записать в отчёт:
##### 1) адрес сети 192.167.38.54/13
- адрес сети 192.160.0.0/13 или 192.160.0.0
![Alt text](image-2.png)
##### 2) перевод маски 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную
- 255.255.255.0(обычная запись) = /24(префиксная запись) = 11111111.11111111.11111111.00000000 (двоичная запись)
![Alt text](image-4.png)
- /15(префиксная запись) = 255.254.0.0(обычная запись) = = 11111111.11111110.00000000.00000000 (двоичная запись)
![Alt text](image-5.png)
- 11111111.11111111.11111111.11110000 (двоичная запись) = 255.255.255.240(обычная запись) = /28(префиксная запись)
![Alt text](image-6.png)
##### 3) минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4
- /8
- hostmin 12.0.0.1
- hostmax 12.255.255.254
![Alt text](image-7.png)

- 11111111.11111111.00000000.00000000 (то есть /16)
- hostmin 12.167.0.1
- hostmax 12.167.255.254
![Alt text](image-8.png)

- 255.255.254.0 (то есть /23)
- hostmin 12.167.38.1
- hostmax 12.167.39.254
![Alt text](image-9.png)

- /4
- hostmin 0.0.0.1
- hostmax 15.255.255.254
![Alt text](image-10.png)

#### 1.2. localhost

Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1

##### localhost (так называемый, «местный» от англ. local, или «локальный хост», по смыслу — этот компьютер) — в компьютерных сетях, стандартное, официально зарезервированное доменное имя для частных IP-адресов (в диапазоне 127.0.0.1 — 127.255.255.254, RFC 2606).

- 192.34.23.100 нельзя
- 127.0.0.2 можно
- 127.1.0.1 можно
- 128.0.0.1 нельзя

#### 1.3. Диапазоны и сегменты сетей

Определить и записать в отчёт:

#### 1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1
- 10.0.0.45 - Class A - private
- 134.43.0.2 - Class B - Public
- 192.168.4.2 - Class C - Private
- 172.20.250.4 - Class B - Private
- 172.0.2.1 - Class B - Public
- 192.172.0.1 - Class C - Public
- 172.68.0.2 - Class B - Public
- 172.16.255.255 - Class B - Private
- 10.10.10.10 - Class A - private
- 192.169.168.1 - Class C - Public

#### 2) какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255
- для сети 10.10.0.0/18 диапазон IP адресов шлюза
- HostMin 10.10.0.1  
- HostMax 10.10.63.254 

## Part 2. Статическая маршрутизация между двумя машинами

##### Поднять две виртуальные машины (далее -- ws1 и ws2)
![Alt text](image-11.png)

##### С помощью команды ip a посмотреть существующие сетевые интерфейсы

- ws1
![Alt text](image-12.png)
- ws2 
![Alt text](image-13.png)

##### Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12
- ws1
![Alt text](image-14.png)
- ws2
![Alt text](image-15.png)

##### 2.1. Добавление статического маршрута вручную

Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add
![Alt text](image-16.png)
![Alt text](image-17.png)

##### 2.2. Добавление статического маршрута с сохранением
##### reboot
##### Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml
![Alt text](image-20.png)
![Alt text](image-21.png)
- ping ws1 - ws2
![Alt text](image-22.png)
- ping ws2 - ws1
![Alt text](image-23.png)

## Part 3. Утилита iperf3

##### 3.1. Скорость соединения
Перевести и записать в отчёт: 
- 8 Mbps в MB/s = 1 MB/s
- 100 MB/s в Kbps = 800000 Kbps
- 1 Gbps в Mbps =1000 Mbps

##### 3.2. Утилита iperf3
установка iperf3
![Alt text](image-24.png)
![Alt text](image-25.png)

Измерить скорость соединения между ws1 и ws2
На ws1 iperf3 -s запускаем режим сервера
![Alt text](image-26.png)
На ws2 iperf3 -c и ip 192.168.100.10 Выполняем роль клиента и измеряем скорость соединения.
![Alt text](image-27.png)

## Part 4. Сетевой экран

#### 4.1. Утилита iptables
##### Создать файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2, применив подряд следующие правила:

1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)

2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)

3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)

4) запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)

5) разрешить echo reply (машина должна "пинговаться")

файл /etc/firewall на ws1 
![Alt text](image-35.png)
файл /etc/firewall на ws2
![Alt text](image-32.png)
Запустить файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh
##### ws1
![Alt text](image-34.png)
##### ws2
![Alt text](image-33.png)
##### iptabels выполняет правила сверху вниз по порядку, то машины ws1 в первую очередь выполнит команду REJECT - отклонить пакет из-за чего пинг не случится. В случае машины ws2 пинг случится, т.к. первым стоит ACCEPT - разрешить прохождение пакета

#### 4.2. Утилита nmap
##### Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен

- пингуем ws1 с ws2 - пингуются
![Alt text](image-36.png)
- пингуем ws2 с ws1 -не пингуются
![Alt text](image-37.png)

##### утилитой nmap показать, что хост машины запущен
![Alt text](image-38.png)

##### Сохранить дампы образов виртуальных машин
![Alt text](image-39.png)

## Part 5. Статическая маршрутизация сети
##### Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))

![Alt text](image-40.png)
##### Настроить конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке.
![Alt text](image-41.png)

##### настройки ws11
![Alt text](image-42.png)
##### настойки r1
![Alt text](image-43.png)
##### настройки r2
![Alt text](image-44.png)
##### настройки ws21
![Alt text](image-45.png)
##### настройки ws22
![Alt text](image-46.png)
##### ip - 4 a
##### ws22 
![Alt text](image-47.png)
##### ws21 
![Alt text](image-48.png)
##### ws11
![Alt text](image-49.png)
##### r1
![Alt text](image-50.png)
##### r2
![Alt text](image-51.png)
###### пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.
![Alt text](image-52.png)
![Alt text](image-53.png)

#### 5.2. Включение переадресации IP-адресов.
##### Для включения переадресации IP, выполните команду на роутерах:
##### sysctl -w net.ipv4.ip_forward=1 При таком подходе переадресация не будет работать после перезагрузки системы.
r1
![Alt text](image-54.png)
r2
![Alt text](image-55.png)
##### Откройте файл /etc/sysctl.conf и добавьте в него следующую строку:
net.ipv4.ip_forward = 1
При использовании этого подхода, IP-переадресация включена на постоянной основе.
r1
![Alt text](image-56.png)
r2
![Alt text](image-57.png)

#### 5.3. Установка маршрута по-умолчанию 

##### Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить `default` перед IP роутера в файле конфигураций
- ws11
![Alt text](image-58.png)
- ws21
![Alt text](image-59.png)
- ws22
![Alt text](image-60.png)
##### ip r
- ws11
![Alt text](image-61.png)
- ws21
![Alt text](image-62.png)
- ws22
![Alt text](image-63.png)

#### 5.4. Добавление статических маршрутов
##### Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций
- r1
![Alt text](image-64.png)
- r2
![Alt text](image-65.png)
##### Вызвать ip r и показать таблицы с маршрутами на обоих роутерах. Пример таблицы на r1:
##### ip r
- r1 
![Alt text](image-66.png)
- r2
![Alt text](image-67.png)
##### Вызвать ip r и показать таблицы с маршрутами на обоих роутерах. Пример таблицы на r1: ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0 на ws11
![Alt text](image-68.png)
##### Ответ - Почему для адреса 10.10.0.0/[маска сети] был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию?Этот маршрут приоритетнее в связи с тем, что роутер самым приоритетным считает маршрут с наиболее длинной маской, а маршрут с маской 0 самый последний в приоритете.

#### 5.5. Построение списка маршрутизаторов

##### Запускаем на r1 tcpdump -tnv -i eth0, вместо eth0 ставим интерфейс (смотрим через tcpdump -D) берём enp0s3; Далее на ws11 пингуем, чтобы была отправка пакетов.
![Alt text](image-70.png)
##### При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21
![Alt text](image-71.png)
###### Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. Причем, каждый пакет имеет свое время жизни. Это количество узлов, которые может пройти пакет перед тем, как он будет уничтожен. Этот параметр записывается в заголовке TTL, каждый маршрутизатор, через который будет проходить пакет уменьшает его на единицу. При TTL=0 пакет уничтожается, а отправителю отсылается сообщение Time Exceeded. Команда traceroute linux использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной.

#### 5.6. Использование протокола ICMP при маршрутизации

##### Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
- tcpdump -n -i eth0 icmp
![Alt text](image-72.png)
##### Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:
- ping -c 1 10.30.0.111
![Alt text](image-73.png)

## Part 6. Динамическая настройка IP с помощью DHCP
###### Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:
![Alt text](image-74.png)
###### в файле resolv.conf прописать nameserver 8.8.8.8.
![Alt text](image-75.png)
###### Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server
![Alt text](image-76.png)
###### Машину ws21 перезагрузить при помощи reboot и через ip a показать, что она получила адрес. Также пропинговать ws22 с ws21.
![Alt text](image-77.png)
![Alt text](image-78.png)
###### Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true
![Alt text](image-79.png)
###### Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты
![Alt text](image-80.png)
![Alt text](image-81.png)
###### перезагрузка 
![Alt text](image-82.png)
###### пингуем ws22 с ws11
![Alt text](image-83.png)
###### ip a
![Alt text](image-84.png)
subnet – сеть, в которой будут работать настройки;
option routers – шлюз по-умолчанию;
range – диапазон IP-адресов;
option domain-name-servers – DNS-сервера;

## Part 7. NAT
###### В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным
- ws22
![Alt text](image-85.png)
- r1
![Alt text](image-86.png)
###### Запустить веб-сервер Apache командой service apache2 start на ws22 и r1

- ws22
![Alt text](image-87.png)
- r1
![Alt text](image-88.png)

###### Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

- 1) удаление правил в таблице filter - iptables -F


- 2) удаление правил в таблице "NAT" - iptables -F -t nat


- 3) отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP

![Alt text](image-90.png)
![Alt text](image-91.png)
###### Проверить соединение между ws22 и r1 командой ping
![Alt text](image-92.png)
###### Добавить в файл ещё одно правило:

- 4) разрешить маршрутизацию всех пакетов протокола ICMP

###### Запускать файл также, как в Части 4
![Alt text](image-93.png)
![Alt text](image-94.png)

- 5) включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)

- Совет: стоит подумать о маршрутизации внутренних пакетов, а также внешних пакетов с установленным соединением

- 6) включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
Совет: стоит учесть, что при попытке подключения возникнет новое tcp-соединение, предназначенное ws22 и 80 порту

![Alt text](image-95.png)
![Alt text](image-96.png)
###### Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой: telnet [адрес] [порт]
![Alt text](image-97.png)
![Alt text](image-98.png)

## Part 8. Дополнительно. Знакомство с SSH Tunnels
###### Запустить на r2 фаервол с правилами из Части 7

![Alt text](image-99.png)
###### Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле /etc/apache2/ports.conf изменить строку Listen 80 на Listen localhost:80)
![Alt text](image-100.png)
###### Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21
- ssh -L 8080:localhost:80 ws22@10.20.0.20
![Alt text](image-101.png)
###### Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11
![Alt text](image-102.png)
###### Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:
telnet 127.0.0.1 [локальный порт]
![Alt text](image-103.png)
![Alt text](image-104.png)